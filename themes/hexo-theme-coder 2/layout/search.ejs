<%- partial('_partial/head') %>
<body>
  <div class="hd">
    <%- partial('_partial/nav') %>
  </div>
  <div class="hd" id="search-results-container">
    <h2>搜索结果</h2>
    <div id="search-info"></div>
    <ul id="search-results"></ul>
  </div>
  <%- partial('_partial/footer') %>

  <!-- Lunr + search logic -->
  <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
  <script>
    // helper to get query param
    function getQuery(){
      var params = new URLSearchParams(window.location.search);
      return (params.get('q') || '').trim();
    }

    function renderResults(items){
      var list = document.getElementById('search-results');
      var info = document.getElementById('search-info');
      list.innerHTML = '';
      if(items.length === 0){
        info.innerText = '未找到匹配结果。';
        return;
      }
      info.innerText = '找到 ' + items.length + ' 条结果：';
      items.forEach(function(it){
        var li = document.createElement('li');
        var a = document.createElement('a');
        a.href = it.url || it.path;
        a.innerText = it.title || it.name || it.path;
        li.appendChild(a);
        if(it.excerpt){
          var p = document.createElement('p');
          p.innerText = it.excerpt.substring(0, 180) + (it.excerpt.length>180? '...':'');
          li.appendChild(p);
        }
        list.appendChild(li);
      });
    }

    (function(){
      var q = getQuery();
      if(!q){
        document.getElementById('search-info').innerText = '请输入查询词。';
        return;
      }
      document.getElementById('search-info').innerText = '正在搜索：' + q;

      // Try to fetch /search.json (generated by hexo-generator-search or similar)
      fetch('/search.json').then(function(res){
        if(!res.ok) throw new Error('noindex');
        return res.json();
      }).then(function(data){
        // build a lunr index
        var idx = lunr(function(){
          this.ref('path');
          this.field('title');
          this.field('content');
          for(var i=0;i<data.length;i++) this.add(data[i]);
        });
        var results = idx.search(q);
        var items = results.map(function(r){
          var doc = data.find(function(d){ return d.path === r.ref; });
          return doc || {path: r.ref};
        });
        renderResults(items);
      }).catch(function(){
        // fallback: search visible post titles on this page
        var els = document.querySelectorAll('.list .postname');
        var found = [];
        els.forEach(function(node){
          var title = node.innerText || node.textContent || '';
          if(title.toLowerCase().indexOf(q.toLowerCase()) !== -1){
            var a = node.closest('a');
            found.push({title: title, url: a? a.href : '#'});
          }
        });
        renderResults(found);
        if(found.length===0){
          document.getElementById('search-info').innerText = '未找到索引（/search.json），已在当前页面标题中尝试匹配，结果：0。';
        }
      });
    })();
  </script>
</body>
</html>
